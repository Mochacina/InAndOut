<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>
<!-- xml 을 java 에서 쓰기 위해 연결되는 interface 가 필요 하다. -->

<!-- 쿼리문을 작성해둔 interface 주소 -->
<mapper namespace="com.ino.delivery.dao.RiderDAO">

	<select id="listRL" resultType="com.ino.delivery.dto.RiderDTO">
		select u.user_id, ud.user_div, ud.user_div_name, p.new_photo_name, re.store_time, u.nickname, u.sido, u.sigungu, u.left_addr from user_div ud
			left join `user` u 
			on ud.user_div = u.user_div
			left join rider_extra re 
			on u.user_id = re.user_id 
			left join photo p 
			on p.photo_div = u.user_id
		where ud.user_div_name = '라이더' or p.cate_no = 'p001'
	</select>

	<select id="dtoROD" resultType="com.ino.delivery.dto.RiderDTO">
		select s.sales_no, s.blind, s.user_id, do.delivery_offer_no, do.from_addr, do.to_addr, do.accept, do.all_show from sales s 
			left join delivery_offer do 
			on do.sales_no = s.sales_no
			left join `user` u 
			on u.user_id = do.user_id 
		where do.delivery_offer_no = #{param1}
	</select>
	
	<select id="listDH" resultType="com.ino.delivery.dto.RiderDTO">
		select dh.delivery_accept_no, dh.delivery_state, dh.delivery_time, do.delivery_offer_no, u.nickname, s.subject, p.new_photo_name, concat(s.sales_sido,' ' , s.sigungu,' ' , s.left_addr) as to_addr from delivery_history dh
			left join delivery_offer do 
			on dh.delivery_accept_no = do.delivery_offer_no
			left join `user` u 
			on do.user_id = u.user_id
			left join sales s 
			on do.sales_no = s.sales_no
			left join photo p 
			on p.photo_div = u.user_id
		where dh.delivery_state = '배송완료' or p.cate_no = 'p001' group by dh.delivery_accept_no;
	</select>
	
	<select id="listRO" resultType="com.ino.delivery.dto.RiderDTO">
		select u.user_id, u.nickname,do.delivery_offer_no,do.from_addr,do.to_addr, do.accept, do.all_show from delivery_offer do 
			left join `user` u 
			on do.user_id = u.user_id
		where do.all_show = 'as' and do.accept is null
	</select>
	
	<select id="listDS" resultType="com.ino.delivery.dto.RiderDTO">
		select u.user_id, u.nickname, do.delivery_offer_no, do.from_addr, do.to_addr, do.accept, do.all_show, dh.delivery_state, dh.delivery_time, dh.delivery_accept_no from delivery_offer do 
			left join `user` u 
			on do.user_id = u.user_id
			left join delivery_history dh 
			on dh.delivery_accept_no = do.delivery_offer_no
		where do.all_show = 'as' and do.accept = 1 group by do.delivery_offer_no
	</select>
	
	<update id="deliveryUpdate" >
		update delivery_offer set accept = 1 where delivery_offer_no = #{param1}
	</update>
	
	<update id="deliveryNone">
		update delivery_offer set accept = 0 where delivery_offer_no = #{param1}
	</update>
	
	<insert id="deliveryInsert">
		insert into delivery_history(delivery_accept_no, delivery_state)
		values(#{param1},'배송접수');
	</insert>
	
	<select id="dtoUO" resultType="com.ino.delivery.dto.RiderDTO">
		select u.nickname, p.new_photo_name, u.user_id, u.user_div from user_div ud 
		   left join `user` u 
		   on ud.user_div = u.user_div 
		   left join photo p 
		   on p.photo_div = u.user_id
		where u.user_id = #{param1} and p.cate_no = 'p001';
	</select>
	
	<select id="dtoUOS" resultType="com.ino.delivery.dto.RiderDTO">
		SELECT s.user_id, s.sales_no, s.subject, s.content, b.biz_name, g.goods_name, p.new_photo_name, concat(s.sales_sido,' ' , s.sigungu,' ' , s.left_addr) as from_addr FROM sales s 
			LEFT JOIN biz b 
			ON s.biz_id = b.biz_id 
			LEFT JOIN goods g 
			ON s.goods_id = g.goods_id 
			LEFT JOIN photo p 
			ON s.user_id = p.photo_div 
		WHERE s.sales_no = 4 OR p.new_photo_name = 'p005';
	</select>
	
	<insert id="select" parameterType="hashmap">
		insert into delivery_history (delivery_accept_no, delivery_state)
		values(#{delivery_accept_no}, #{delivery_state});
	</insert>
	
	<insert id="writeUO" parameterType="hashmap">
		insert into delivery_offer (sales_no, rider_id, user_id, from_addr, to_addr, accept, all_show)	
		values(#{sales_no}, #{rider_id}, #{user_id}, #{from_addr}, #{to_addr}, null, 'as'); 
	</insert>
	
</mapper>